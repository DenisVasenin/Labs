{
    "collab_server" : "",
    "contents" : "# Анализ почерка. Построение DF времен перехода от одной клавиши к другой\nlibrary('reshape2')\nlibrary('ggplot2')\nlibrary('plyr')\n\n# ------------------ Грузим исходные данные ------------------\n# определяем рабочий каталог, в котором хранится исходный файл с общим набором данных\n\n#  Загружаем общий набор с метками\nalldata1 <- read.csv(\"k2k_alldata.csv\", header = TRUE)\n# Загружаем таблицу расшифровки меток\nkeyID_name <- read.csv(\"userID_Name.csv\", header = TRUE)\nusersQ <- nrow(str(keyID_name))\n\n# ------------ агрегируем и проводим первичное исследование ------------\n\n# Получаем агрегированные данные - кол-во переходов для каждой клавиши\nkqdata <- acast(alldata1, key1 ~ key2)\nstr(kqdata)\n\n# Получаем агрегированные данные - среднее время перехода от клавиши\nkmdata <- acast(alldata1, key1 ~ key2, value.var = \"dtime\", mean, fill = 0)\ndim(kmdata)\n\n# фильтруем данные\nalldata2 <- alldata1[alldata1$dtime < 2000, ]\nstr(alldata2)\nprint(paste(\"в качестве выбросов отфильтрован \", round(100*(1-nrow(alldata2)/nrow(alldata1)),2), \"% переходов\"))\ntittle = paste(\"Распределение времени перехода между клавишами для \", usersQ, \"пользователей\")\nqplot(data= alldata2, dtime, main = tittle, color=as.factor(alldata2$userId), binwidth=100)\n\n# ------------ Анализируем данные по каждому пользователю отдельно -------------\ndtTabList <- list(1:usersQ)\nminTab <- kqdata\nminTabfun <- Vectorize(function(xTab, yTab) min(xTab, yTab), c(\"xTab\", \"yTab\"))\nfor(iu in 1:usersQ) {\n  # Получаем данные - кол-во переходов для каждой пары клавиш для фиксированного пользователя\n  data1 <- alldata1[alldata1$userId == iu,]\n  str(data1)\n  kqdata1 <- acast(data1, key1 ~ key2)\n  str(kqdata1)\n  kqdata2 <- kqdata*0\n  kqdata2[rownames(kqdata1), colnames(kqdata1)] <- kqdata1\n  minTab <- matrix(data= minTabfun(minTab,kqdata2), nrow=nrow(kqdata))\n  sum(minTab)\n  # Получаем данные - среднее время перехода для каждой пары клавиш для фиксированного пользователя\n  kmdata1 <- acast(data1, key1 ~ key2, value.var = \"dtime\", mean, fill = 0)\n  dtTabList[[iu]] <- kmdata1\n}\nQvect <- as.vector(minTab)\ntable(Qvect)\n\n# Будем исследовать только те переходы, которые встречаются у каждого пользователя более раза\nu1 <- Qvect > 1\n# таких переходов всего \nsum(u1)\n# вытащим коды клавиш для таких переходов\nu1nums <- (1:length(Qvect))[u1]\nk2kQ <- length(u1nums)\nu1rows <- (u1nums-1) %% nrow(kqdata) +1\nu1cols <- (u1nums-1) %/% nrow(kqdata) +1 \nkey1 <- rownames(kqdata)[u1rows]\nkey2 <- rownames(kqdata)[u1cols]\nlength(key1)\n# проверка:\nfor(nn in 1:k2kQ) {\n  qq <- minTab[u1rows[nn], u1cols[nn]]\n  # key1[nn] <- rownames(kqdata)[u1rows[nn]]\n  # key2[nn] <- rownames(kqdata)[u1cols[nn]]\n  print(paste(\"Переход от клавиши\", key1, \"к клавише\", key2, \"зафиксирован минимум\", qq, \"раз\"))\n} \n\n# Для каждого пользователя теперь вытаскиваем средние времена перехода от клавиш key1 к key2\ndtk2kfun = function(k2kTab) {\n  dt<- 1:k2kQ *1.0\n  for(nn in 1:k2kQ) dt[nn]= k2kTab[key1[nn], key2[nn]]\n  dt\n}\n\ndtmean <- sapply(dtTabList, dtk2kfun)\nstr(dtmean)\ndtmeanDF <- data.frame(dtmean, row.names = paste0(key1,\"_\",key2))\ncolnames(dtmeanDF) <- paste0(\"usr\",1:usersQ)\ndim(dtmeanDF)\nqplot(data = dtmeanDF, x=usr1, y=usr4)\n\n# -------------- Создаем общую матрицу данных для построения классификатора ------------\n\n# Для каждого пользователя формируем таблицу с его данными перехода между отобранными клавишами\n# Используем отфильтрованный набор с метками alldata2\nstr(alldata2)\n\nuserK2KDt_DF0 <- as.data.frame(t(dtmean) )\nuserK2KDt_DF0$userId <- 1:usersQ\nhead(userK2KDt_DF0, n=2)\n\n# Задаем кол-во генерируемых наблюдений NN - объем выборки для каждого пользователя и готовим таблицы\nNN = 1000\n# таблица для всех измерений\nALLuserK2KDt_DF <- userK2KDt_DF0[userK2KDt_DF0$V1 == 0, ]\ncolnames(ALLuserK2KDt_DF) <- c(paste0(key1,\"_\",key2), \"usrID\")\n# таблица для одного пользователя\nuserK2KDt_DF <- data.frame(matrix(0, nrow = NN, ncol = k2kQ))\ncolnames(userK2KDt_DF) <- paste0(key1,\"_\",key2)\nuserK2KDt_DF$usrID <- 0\ndim(userK2KDt_DF)\ndim(ALLuserK2KDt_DF)\n\ni_user = 1\nfor(i_user in 1:usersQ) {\n  k2kdt_1 = list()\n  # allcombQ <- 1\n  # Определяем список времен переходов для каждой пары клавиш\n  for(nn in 1:k2kQ) {\n    u <- (alldata2$key1 == key1[nn]) & (alldata2$key2 == key2[nn]) & (alldata2$userId == i_user)\n    # allcombQ <- allcombQ*sum(u)\n    # print(sum(u))\n    k2kdt_1[[nn]] <- alldata2$dtime[u]\n  }\n  #k2kdt_1[[1]]\n  # Делаем случайный выбор времени перехода для каждой пары клавиш и создаем df c nrow=NN - кол-во измерений\n  for(nn in 1:k2kQ) {\n    rand_dts <- sample(k2kdt_1[[nn]], size = NN, replace = TRUE)\n    userK2KDt_DF[,nn] <- rand_dts\n  }\n  userK2KDt_DF$usrID <- i_user\n  ALLuserK2KDt_DF <- rbind(ALLuserK2KDt_DF, userK2KDt_DF)\n}\ndim(ALLuserK2KDt_DF) \n# Записываем это все в файл\n\nwrite.csv(ALLuserK2KDt_DF, \"ALLuserK2KDt_DF.csv\", row.names = FALSE)\n",
    "created" : 1486050215709.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2683989537",
    "id" : "4D7E9812",
    "lastKnownWriteTime" : 1483045372,
    "last_content_update" : 1483045372,
    "path" : "~/Documents/Programs/R/MetOpt/RGR/keylog_analys.R",
    "project_path" : "keylog_analys.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}